<!DOCTYPE HTML>
<html><head><title>Introduction to Singletons (Part 4) · in Code</title><meta name="description" content="Weblog of Justin Le, covering various adventures in programming and explorations in the vast worlds of computation physics, and knowledge."><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><meta name="flattr:id" content="3p9jqr"><meta property="og:site_name" content="in Code"><meta property="og:description" content="Hi again! Welcome back; let’s jump right into part 4 of our journey through the singleton design pattern and the great singletons library! Please check out the first three parts of the series and make sure you are comfortable with them before reading on. I definitely also recommend trying out some or all of the exercises, since we are going to be building on the concepts in those posts in a pretty heavy way. Today we’re going to jump straight into functional programming at the type level!"><meta property="og:type" content="article"><meta property="og:title" content="Introduction to Singletons (Part 4)"><meta property="og:image" content="https://blog.jle.im/img/site_logo.jpg"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://blog.jle.im/entry/introduction-to-singletons-4.html"><meta name="twitter:card" content="summary"><meta name="twitter:creator:id" content="mstk"><link rel="author" href="https://plus.google.com/107705320197444500140"><link rel="alternate" type="application/rss+xml" title="in Code (RSS Feed)" href="http://feeds.feedburner.com/incodeblog"><link rel="canonical" href="https://blog.jle.im/entry/introduction-to-singletons-4.html"><link href="https://blog.jle.im/favicon.ico" rel="shortcut icon"><link href="https://blog.jle.im/css/toast.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/font.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/main.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/page/entry.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/pygments.css" rel="stylesheet" type="text/css"><script type="text/javascript">var page_data = {};
var disqus_shortname='incode';
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-443711-8', 'jle.im');
ga('send', 'pageview');
</script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5234d67a6b68dcd4"></script><script type="text/javascript" src="https://blog.jle.im/js/page/entry_toc.js"></script><script type="text/javascript" src="https://blog.jle.im/js/disqus_count.js"></script><script type="text/javascript" src="https://blog.jle.im/js/social.js"></script><script type="text/javascript" src="https://blog.jle.im/js/jquery/jquery.toc.js"></script><script type="text/javascript" src="https://blog.jle.im/purescript/entry.js"></script></head><body><div id="fb-root"><script>(function(d, s, id) {
 var js, fjs = d.getElementsByTagName(s)[0];
 if (d.getElementById(id)) return;
 js = d.createElement(s); js.id = id;
 js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=641852699171929";
 fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script></div><div id="header-container"><div id="navbar-container" class="tile"><nav id="navbar-content"><div class="nav-info"><h1 class="site-title"><a href="https://blog.jle.im/" class="nav-title">in Code</a></h1><span class="nav-author">Justin Le</span></div><ul class="nav-links"><li><a href="https://blog.jle.im/">home</a></li><li><a href="https://blog.jle.im/entries.html">archives</a></li><div class="clear"></div></ul></nav></div><div id="header-content"></div></div><div id="body-container" class="container"><div id="main-container" class="grid"><div class="entry-section unit span-grid" role="main"><article class="tile article"><header><div class="unposted-banner">Unposted entry</div><h1 id="title">Introduction to Singletons (Part 4)</h1><p class="entry-info">by <a class="author" href="https://blog.jle.im/">Justin Le</a></p><p><span class="source-info"><a class="source-link" href="https://github.com/mstksg/inCode/tree/master/copy/entries/singletons-4.md">Source</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://github.com/mstksg/inCode/tree/gh-pages/entry/introduction-to-singletons-4.md">Markdown</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://blog.jle.im/entry/introduction-to-singletons-4.tex">LaTeX</a><span class="info-separator"> &diams; </span></span>Posted in <a href="https://blog.jle.im/entries/category/@haskell.html" class="tag-a-category" title="Functional, pure, non-strict, statically and strongly typed, natively
compiled...really just the king of great languages.">Haskell</a><span class="info-separator"> &diams; </span><a class="comment-link" href="#disqus_thread">Comments</a></p></header><hr><aside class="contents-container"><h5 id="contents-header">Contents</h5><div id="toc"></div></aside><div class="main-content copy-content"><p>Hi again! Welcome back; let’s jump right into part 4 of our journey through the <em>singleton design pattern</em> and the great <em><a href="http://hackage.haskell.org/package/singletons">singletons</a></em> library!</p>
<p>Please check out <a href="https://blog.jle.im/entries/series/+introduction-to-singletons.html">the first three parts of the series</a> and make sure you are comfortable with them before reading on. I definitely also recommend trying out some or all of the exercises, since we are going to be building on the concepts in those posts in a pretty heavy way.</p>
<p>Today we’re going to jump straight into <em>functional programming</em> at the type level!</p>
<h2 id="review">Review</h2>
<p>Just as a quick review, this entire series we have been working with a <code>Door</code> type:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="fu">$</span>(singletons [d|</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  data DoorState = Opened | Closed | Locked</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">    deriving (Show, Eq)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  |])</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">data</span> <span class="dt">Door</span><span class="ot"> ::</span> <span class="dt">DoorState</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">    <span class="dt">UnsafeMkDoor</span><span class="ot"> ::</span> {<span class="ot"> doorMaterial ::</span> <span class="dt">String</span> } <span class="ot">-&gt;</span> <span class="dt">Door</span> s</a></code></pre></div>
<p>And we talked about using <code>Sing s</code>, or <code>SDoorState s</code>, to represent the state of the door (in its type) as a run-time value. We’ve been using a wrapper to existentially hide the door state type, but also stuffing in a singleton to let us recover the type information once we want it again:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">data</span> <span class="dt">SomeDoor</span><span class="ot"> ::</span> <span class="dt">Type</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">    <span class="dt">MkSomeDoor</span><span class="ot"> ::</span> <span class="dt">Sing</span> s <span class="ot">-&gt;</span> <span class="dt">Door</span> s <span class="ot">-&gt;</span> <span class="dt">SomeDoor</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="ot">mkSomeDoor ::</span> <span class="dt">DoorState</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">SomeDoor</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">mkSomeDoor ds mat <span class="fu">=</span> withSomeSing ds <span class="fu">$</span> \dsSing <span class="ot">-&gt;</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    <span class="dt">MkSomeDoor</span> dsSing (<span class="dt">UnsafeMkDoor</span> mat)</a></code></pre></div>
<p>In Part 3 we talked about a <code>Pass</code> data type that we used to talk about whether or not we can walk through or knock on a door:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="fu">$</span>(singletons [d|</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">  data Pass = Obstruct | Allow</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    deriving (Show, Eq)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">  |])</a></code></pre></div>
<p>And we defined type-level functions on it using <em>singletons</em> Template Haskell:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="fu">$</span>(singletons [d|</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  statePass :: DoorState -&gt; Pass</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  statePass Opened = Allow</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  statePass Closed = Obstruct</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  statePass Locked = Obstruct</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  |])</a></code></pre></div>
<p>This essentially generates these three things:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="ot">statePass ::</span> <span class="dt">DoorState</span> <span class="ot">-&gt;</span> <span class="dt">Pass</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">statePass <span class="dt">Opened</span> <span class="fu">=</span> <span class="dt">Allow</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">statePass <span class="dt">Closed</span> <span class="fu">=</span> <span class="dt">Obstruct</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">statePass <span class="dt">Locked</span> <span class="fu">=</span> <span class="dt">Obstruct</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="kw">type</span> family <span class="dt">StatePass</span> (<span class="ot">s ::</span> <span class="dt">DoorState</span>)<span class="ot"> ::</span> <span class="dt">Pass</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    <span class="dt">StatePass</span> &#39;<span class="dt">Opened</span> <span class="fu">=</span> &#39;<span class="dt">Allow</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">    <span class="dt">StatePass</span> &#39;<span class="dt">Closed</span> <span class="fu">=</span> &#39;<span class="dt">Obstruct</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">    <span class="dt">StatePass</span> &#39;<span class="dt">Locked</span> <span class="fu">=</span> &#39;<span class="dt">Obstruct</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="ot">sStatePass ::</span> <span class="dt">Sing</span> s <span class="ot">-&gt;</span> <span class="dt">Sing</span> (<span class="dt">StatePass</span> s)</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">sStatePass <span class="fu">=</span> \<span class="kw">case</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13">    <span class="dt">SOpened</span> <span class="ot">-&gt;</span> <span class="dt">SAllow</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14">    <span class="dt">SClosed</span> <span class="ot">-&gt;</span> <span class="dt">SObstruct</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15">    <span class="dt">SLocked</span> <span class="ot">-&gt;</span> <span class="dt">SObstruct</span></a></code></pre></div>
<p>And we can use <code>StatePass</code> as a type-level function while using <code>sStatePass</code> to manipulate the singletons representing <code>s</code> and <code>StatePass s</code>.</p>
<p>We used this as a constraint to restrict how we can call our functions:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="ot">knockP ::</span> (<span class="dt">StatePass</span> s <span class="fu">~</span> &#39;<span class="dt">Obstruct</span>) <span class="ot">=&gt;</span> <span class="dt">Door</span> s <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">knockP d <span class="fu">=</span> putStrLn <span class="fu">$</span> <span class="st">&quot;Knock knock on &quot;</span> <span class="fu">++</span> doorMaterial d <span class="fu">++</span> <span class="st">&quot; door!&quot;</span></a></code></pre></div>
<p>But then we wondered…is there a way to not only <em>restrict</em> our functions, but to describe how the inputs and outputs are related to each other?</p>
<h2 id="inputs-and-outputs">Inputs and Outputs</h2>
<p>In the past we have settled with very simple relationships, like:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="ot">closeDoor ::</span> <span class="dt">Door</span> &#39;<span class="dt">Opened</span> <span class="ot">-&gt;</span> <span class="dt">Door</span> &#39;<span class="dt">Closed</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">closeDoor (<span class="dt">UnsafeMkDoor</span> m) <span class="fu">=</span> <span class="dt">UnsafeMkDoor</span> m</a></code></pre></div>
<p>This means that the relationship between the input and output is that the input is opened…and is then closed.</p>
<p>However, armed with promotion of type-level functions, writing more complex relationships becomes fairly straightforward!</p>
<p>We can write a function <code>mergeDoor</code> that “merges” two doors together, in sequence:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="ot">mergeDoor ::</span> <span class="dt">Door</span> s <span class="ot">-&gt;</span> <span class="dt">Door</span> t <span class="ot">-&gt;</span> <span class="dt">Door</span> <span class="fu">????</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2">mergeDoor d e <span class="fu">=</span> <span class="dt">UnsafeMkDoor</span> <span class="fu">$</span> doorMaterial d <span class="fu">++</span> <span class="st">&quot; and &quot;</span> <span class="fu">++</span> doorMaterial e</a></code></pre></div>
<p>A merged door will have a material that is composite of the original materials. But, what will the new <code>DoorState</code> be? What goes in the <code>???</code> above?</p>
<p>Well, if we can write the function as a normal function in values…<em>singletons</em> lets us use it as a function on types. Let’s write that relationship. Let’s say merging takes on the higher “security” option — merging opened with locked is locked, merging closed with opened is closed, merging locked with closed is locked.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="fu">$</span>(singletons [d|</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  mergeState :: DoorState -&gt; DoorState -&gt; DoorState</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  mergeState Opened d      = d</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">  mergeState Closed Opened = Closed</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">  mergeState Closed Closed = Closed</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">  mergeState Closed Locked = Locked</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">  mergeState Locked _      = Locked</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">  |])</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co">-- Alternatively, taking advantage of the derived Ord instance:</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="fu">$</span>(singletons [d|</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">  mergeState :: DoorState -&gt; DoorState -&gt; DoorState</a>
<a class="sourceLine" id="cb9-13" data-line-number="13">  mergeState = max</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">  |])</a></code></pre></div>
<p>This makes writing <code>mergeDoor</code>’s type fairly straightforward!</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1">mergeDoor</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="ot">    ::</span> <span class="dt">Door</span> s</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">    <span class="ot">-&gt;</span> <span class="dt">Door</span> t</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    <span class="ot">-&gt;</span> <span class="dt">Door</span> (<span class="dt">MergeState</span> s t)</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">mergeDoor d e <span class="fu">=</span> <span class="dt">UnsafeMkDoor</span> <span class="fu">$</span> doorMaterial d <span class="fu">++</span> <span class="st">&quot; and &quot;</span> <span class="fu">++</span> doorMaterial e</a></code></pre></div>
<p>And, with the help of singletons, we can also write this for our doors where we don’t know the types until runtime:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="ot">mergeSomeDoor ::</span> <span class="dt">SomeDoor</span> <span class="ot">-&gt;</span> <span class="dt">SomeDoor</span> <span class="ot">-&gt;</span> <span class="dt">SomeDoor</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">mergSomeDoor (<span class="dt">MkSomeDoor</span> s d) (<span class="dt">MkSomeDoor</span> t e) <span class="fu">=</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">    <span class="dt">MkSomeDoor</span> (sMergeState s t) (mergeDoor d e)</a></code></pre></div>
<p>To see why this typechecks properly, compare the types of <code>sMergeState</code> and <code>mergeDoor</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="ot">sMergeState ::</span> <span class="dt">Sing</span> s <span class="ot">-&gt;</span> <span class="dt">Sing</span> t <span class="ot">-&gt;</span> <span class="dt">Sing</span> (<span class="dt">MergeState</span> s t)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="ot">mergeDoor   ::</span> <span class="dt">Door</span> s <span class="ot">-&gt;</span> <span class="dt">Door</span> t <span class="ot">-&gt;</span> <span class="dt">Sing</span> (<span class="dt">MergeState</span> s t)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="dt">MkSomeDoor</span><span class="ot">  ::</span> <span class="dt">Sing</span> (<span class="dt">MergeState</span> s t) <span class="ot">-&gt;</span> <span class="dt">Door</span> (<span class="dt">MergeState</span> s t) <span class="ot">-&gt;</span> <span class="dt">SomeDoor</span></a></code></pre></div>
<p>Because the results both create types <code>MergeState s t</code>, <code>MkSomeDoor</code> is happy to apply them to each other, and everything typechecks. However, if, say, we directly stuffed <code>s</code> or <code>t</code> into <code>MkSomeDoor</code>, things would fall apart and not typecheck.</p>
<p>And so now we have full expressiveness in determining input and output relationships! Once we unlock the power of type-level functions with <em>singletons</em>, writing type-level relationships become as simple as writing value-level ones. If you can write a value-level function, you can write a type-level function!</p>
<h2 id="kicking-it-up-a-notch">Kicking it up a notch</h2>
<p>Alright, so let’s see how far we can really take this!</p>
<p>Let’s make a data type that represents a <em>series of hallways</em>, each linked by a door. A hallway is either an empty stretch with no door, or two hallways linked by a door. We’ll structure it like a linked list, and store the list of all door states as a type-level list as a type parameter:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Hallway</span><span class="ot"> ::</span> [<span class="dt">DoorState</span>] <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">    <span class="dt">HEnd</span><span class="ot">  ::</span> <span class="dt">Hallway</span> &#39;[]</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">    <span class="co">-- ^ end of the hallway, a stretch with no doors</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="ot">    (:&lt;#) ::</span> <span class="dt">Door</span> s</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">          <span class="ot">-&gt;</span> <span class="dt">Hallway</span> ss</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">          <span class="ot">-&gt;</span> <span class="dt">Hallway</span> (s &#39;<span class="fu">:</span> ss)</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">    <span class="co">-- ^ A door connected to a hallway is a new</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">    <span class="co">--   hallway, and we track the door&#39;s state in the list</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9">    <span class="co">--   of hallway door states</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="kw">infixr</span> <span class="dv">5</span> <span class="fu">:&lt;#</span></a></code></pre></div>
<p>So we might have:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" data-line-number="1">ghci<span class="fu">&gt;</span> <span class="kw">let</span> door1 <span class="fu">=</span> <span class="dt">UnsafeMkDoor</span> <span class="fu">@</span>&#39;<span class="dt">Closed</span> <span class="st">&quot;Oak&quot;</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">ghci<span class="fu">&gt;</span> <span class="kw">let</span> door2 <span class="fu">=</span> <span class="dt">UnsafeMkDoor</span> <span class="fu">@</span>&#39;<span class="dt">Opened</span> <span class="st">&quot;Spruce&quot;</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3">ghci<span class="fu">&gt;</span> <span class="kw">let</span> door3 <span class="fu">=</span> <span class="dt">UnsafeMkDoor</span> <span class="fu">@</span>&#39;<span class="dt">Locked</span> <span class="st">&quot;Acacia&quot;</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">ghci<span class="fu">&gt;</span> <span class="fu">:</span>t door1 <span class="fu">:&lt;#</span> door2 <span class="fu">:&lt;#</span> door3 <span class="fu">:&lt;#</span> <span class="dt">HEnd</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="dt">Hallway</span> &#39;[ &#39;<span class="dt">Closed</span>, &#39;<span class="dt">Opened</span>, &#39;<span class="dt">Locked</span> ]</a></code></pre></div>
<p>That is, a <code>Hallway '[ s, t, u ]</code> is a hallway consisting of a <code>Door s</code>, a <code>Door t</code>, and a <code>Door u</code>, constructed like a linked list in Haskell.</p>
<p>Now, let’s write a function to <em>collapse all doors in a hallway down to a single door</em>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="ot">collapseHallway ::</span> <span class="dt">Hallway</span> ss <span class="ot">-&gt;</span> <span class="dt">Door</span> <span class="fu">?????</span></a></code></pre></div>
<p>Basically, we want to merge all of the doors one after the other, collapsing it until we have a single door state. Luckily, <code>MergeState</code> is both commutative and associative and has an identity, so this can be defined sensibly.</p>
<p>First, let’s think about the type we want. What will the result of merging <code>ss</code> be?</p>
<p>We can pattern match and collapse an entire list down item-by-item:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="fu">$</span>(singletons [d|</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">  mergeStates :: [DoorState] -&gt; DoorState</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  mergeStates []     = Opened               -- ^ the identity of mergeState</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">  mergeStates (s:ss) = s `mergeState` mergeStates ss</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">  |])</a></code></pre></div>
<p>Again, remember that this also defines the type family <code>MergeStates</code> and the singleton function <code>sMergeStates :: Sing ss -&gt; Sing (MergeStates ss)</code>.</p>
<p>With this, we can write <code>collapseHallway</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="ot">collapseHallway ::</span> <span class="dt">Hallway</span> ss <span class="ot">-&gt;</span> <span class="dt">Door</span> (<span class="dt">MergeStates</span> ss)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">collapseHallway <span class="dt">HEnd</span>       <span class="fu">=</span> <span class="dt">UnsafeMkDoor</span> <span class="st">&quot;End of Hallway&quot;</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3">collapseHallway (d <span class="fu">:&lt;#</span> ds) <span class="fu">=</span> d <span class="ot">`mergeDoor`</span> collapseHallway ds</a></code></pre></div>
<p>Now, because the structure of <code>collapseHallway</code> perfectly mirrors the structure of <code>mergeStates</code>, this all typechecks, and we’re done!</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" data-line-number="1">ghci<span class="fu">&gt;</span> collapseHallway (door1 <span class="fu">:&lt;#</span> door2 <span class="fu">:&lt;#</span> door3 <span class="fu">:&lt;#</span> <span class="dt">HEnd</span>)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="dt">UnsafeMkDoor</span> <span class="st">&quot;Oak and Spruce and Acacia and End of Hallway&quot;</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="ot">    ::</span> <span class="dt">Door</span> &#39;<span class="dt">Locked</span></a></code></pre></div></div><footer><hr><div class="copy-content"><p>Hi, thanks for reading! You can reach me via email at <a href="mailto:justin@jle.im">justin@jle.im</a>, or at twitter at <a href="https://twitter.com/mstk">@mstk</a>! This post and all others are published under the <a href="https://creativecommons.org/licenses/by-nc-nd/3.0/">CC-BY-NC-ND 3.0</a> license. Corrections and edits via pull request are welcome and encouraged at <a href="https://github.com/mstksg/inCode">the source repository</a>.</p>
<p>If you feel inclined, or this post was particularly helpful for you, why not consider <a href="https://www.patreon.com/justinle/overview">supporting me on Patreon</a>, or a <a href="bitcoin:3D7rmAYgbDnp4gp4rf22THsGt74fNucPDU">BTC donation</a>? :)</p></div><div class="clear"></div><ul class="entry-series"><li><div>This entry is a part of a series called <b>&quot;Introduction to Singletons&quot;</b>.  Find the rest of the entries in this series at its <a href="https://blog.jle.im/entries/series/+introduction-to-singletons.html" class="tag-a-series" title="+Introduction to Singletons"> series history</a>.</div></li></ul><ul class="tag-list"><li><a href="https://blog.jle.im/entries/tagged/dependent-types.html" class="tag-a-tag">#dependent types</a></li><li><a href="https://blog.jle.im/entries/tagged/functional-programming.html" class="tag-a-tag">#functional programming</a></li><li><a href="https://blog.jle.im/entries/tagged/haskell.html" class="tag-a-tag">#haskell</a></li><li><a href="https://blog.jle.im/entries/tagged/singletons.html" class="tag-a-tag">#singletons</a></li><li><a href="https://blog.jle.im/entries/tagged/types.html" class="tag-a-tag">#types</a></li><li><a href="https://blog.jle.im/entries/category/@haskell.html" class="tag-a-category">@HASKELL</a></li><li><a href="https://blog.jle.im/entries/series/+introduction-to-singletons.html" class="tag-a-series">+Introduction to Singletons</a></li></ul><aside class="social-buttons"><div class="addthis_toolbox addthis_default_style addthis-buttons"><a class="addthis_button_facebook_like" fb:like:layout="button_count"></a><a class="addthis_button_tweet"></a><a class="addthis_button_google_plusone" g:plusone:size="medium"></a><a class="addthis_counter addthis_pill_style"></a></div><div class="custom-social-buttons"><div class="custom-social-button"><a href="https://www.reddit.com/submit" onclick="window.location = &#39;https://www.reddit.com/submit?url=&#39;+ encodeURIComponent(window.location); return false"><img src="https://www.reddit.com/static/spreddit7.gif" alt="submit to reddit"></a></div></div></aside><nav class="next-prev-links"><ul><li class="next-entry-link">(Next) <a href="https://blog.jle.im/entry/introducing-in-code.html">Introducing &quot;in Code&quot;!</a> &rarr;</li></ul></nav></footer></article><div class="post-entry"><div class="tile"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://blog.jle.im/entry/introduction-to-singletons-4.html';
    this.page.identifier = 'singletons-4';
};
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//incode.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a><br></noscript><a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footer-container"><div id="footer-content"><div class="tile"><div class="footer-copyright">&copy; 2018 Justin Le <span class="license-link">(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/" class="license">CC-BY-NC-ND 3.0</a>)</span></div><div class="footer-follow social-follows"><ul class="social-follows-list"><li><ul class="social-follows-list-social"><li><a class="social-follow-twitter" title="Follow me on Twitter!" href="https://twitter.com/intent/user?user_id=mstk" onclick="window.open(
  &#39;http://twitter.com/intent/user?user_id=907281&#39;,
  &#39;facebook-share-dialog&#39;,
  &#39;width=550,height=520&#39;);
return false;
">Twitter</a></li><li><a class="social-follow-github" title="Fork me on Github!" href="https://github.com/mstksg">Github</a></li><li><a class="social-follow-twitch" title="Watch me on Twitch!" href="https://www.twitch.tv/justin_l">Twitch</a></li><li><a class="social-follow-patreon" title="Support me on Patreon!" href="https://www.patreon.com/justinle/overview">Patreon</a></li><li><a class="social-follow-gplus" title="Add me on Google+!" href="https://plus.google.com/+JustinLe">Google+</a></li><li><a class="social-follow-keybase" title="Track me on Keybase!" href="https://keybase.io/mstksg">Keybase</a></li><li><a class="social-follow-linkedin" title="Connect with me on LinkedIn!" href="https://linkedin.com/in/lejustin">LinkedIn</a></li><li><a class="social-follow-bitcoin" title="Donate via bitcoin!" href="bitcoin:3D7rmAYgbDnp4gp4rf22THsGt74fNucPDU">Bitcoin</a></li></ul></li><li><ul class="social-follows-list-site"><li><a class="social-follow-rss" title="Subscribe to my RSS Feed!" href="http://feeds.feedburner.com/incodeblog">RSS</a></li><li><a class="social-follow-email" title="Subscribe to the mailing list!" href="https://feedburner.google.com/fb/a/mailverify?loc=en_US&amp;uri=incodeblog">Mailing list</a></li></ul></li></ul></div></div></div></div></body></html>